define("local_oer/output-lazy",["exports","local_oer/service-lazy","core/templates","local_oer/config-lazy","core/modal_factory","core/modal_events","core/fragment","core/str","core/log"],(function(_exports,Service,Templates,Config,ModalFactory,ModalEvents,Fragment,Str,_log){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * Open Educational Resources Plugin
   *
   * @author     Christian Ortner <christian.ortner@tugraz.at>
   * @copyright  2022-2023 Educational Technologies, Graz, University of Technology
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.showForm=_exports.showFiles=_exports.prepareFiles=void 0,Service=_interopRequireWildcard(Service),Templates=_interopRequireWildcard(Templates),Config=_interopRequireWildcard(Config),ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents),Fragment=_interopRequireWildcard(Fragment),Str=_interopRequireWildcard(Str),_log=(obj=_log)&&obj.__esModule?obj:{default:obj};const showFiles=async(init,keepFocus)=>{const output=Config.getOutputValues(init),oldSearchInput=document.getElementById("local_oer_searchFilecardsInput");let oldSearchValue="";null!==oldSearchInput&&(oldSearchValue=oldSearchInput.value);const{html:html,js:js}=await Templates.renderForPromise("local_oer/files",output);Templates.replaceNodeContents("#local-oer-overview",html,js);const searchInput=document.getElementById("local_oer_searchFilecardsInput");keepFocus&&null!==searchInput&&(searchInput.value=oldSearchValue,searchInput.focus()),showPagination()};_exports.showFiles=showFiles;_exports.showForm=(type,title,options)=>{const params=JSON.stringify(options),courseid=document.getElementById("local_oer_files_main_area").dataset.courseid,context=document.getElementById("local_oer_files_main_area").dataset.context,args={courseid:courseid,formtype:type,params:params},form=Fragment.loadFragment("local_oer","formdata",context,args);form.then((data=>{!1!==data.includes('<input name="nosave" type="hidden" value="1" />')&&(type="nosave"),showFormModal(form,type,title,options)})).catch(_log.default.error)};const showFormModal=async(form,type,title,options)=>{const element=document.getElementById("local_oer_files_main_area"),modaltype="nosave"===type?ModalFactory.types.CANCEL:ModalFactory.types.SAVE_CANCEL,modal=await ModalFactory.create({type:modaltype,title:title,body:form});switch(modal.setLarge(),modal.show(),type){case"FileinfoForm":case"FileinfoFormSave":initPersonButtonListener(),addRemoveTagListener("storedperson"),initSetPreferenceListener(modal),addInputFieldInputListener("stored","tags");break;case"PreferenceForm":case"PreferenceFormSave":initPersonButtonListener(),addRemoveTagListener("storedperson"),addInputFieldInputListener("stored","tags")}modal.getRoot().on(ModalEvents.hidden,(()=>{modal.destroy()})),modal.getRoot().on(ModalEvents.save,(()=>{saveForm(modal,element,options,type,title)}))},saveForm=async(modal,element,options,type,title)=>{const{html:html,js:js}=await Templates.renderForPromise("local_oer/spinner",[]),node=document.querySelectorAll("[data-oerid='"+options.identifier+"']");Templates.replaceNodeContents(node,html,js);const formData=modal.getRoot().find("form").serialize(),saveargs={courseid:element.dataset.courseid,formtype:type+"Save",params:JSON.stringify(Object.assign(options,{settings:formData}))},context=element.dataset.context,formSubmit=Fragment.loadFragment("local_oer","formdata",context,saveargs);formSubmit.then((async response=>{-1!==response.indexOf("<form")?(modal.destroy(),options.hasOwnProperty("preference")&&(delete options.preference,replaceFileInfo(await Service.loadFile(options.identifier))),showFormModal(formSubmit,type,title,options)):"FileinfoForm"===type?replaceFileInfo(await Service.loadFile(options.identifier)):"PreferenceForm"===type&&prepareFiles(await Service.loadFiles(),!0)})).catch(_log.default.error)},replaceFileInfo=promises=>{promises[0].then((response=>{const filelist=document.getElementById("local-oer-overview-filelist").innerHTML,output=JSON.parse(filelist);output.files.forEach(((file,index)=>{file.identifier===response.file.identifier&&(output.files[index]=response.file)})),document.getElementById("local-oer-overview-filelist").innerHTML=JSON.stringify(output),showFiles(!1,!0)})).catch(_log.default.error)},prepareFiles=(promises,init)=>{promises[0].then((response=>{document.getElementById("local-oer-overview-filelist").innerHTML=JSON.stringify(response),showFiles(init,!0)})).catch(_log.default.error)};_exports.prepareFiles=prepareFiles;const addInputFieldInputListener=(prefix,area)=>{addRemoveTagListener(prefix+area),showTags(prefix+area),document.getElementById("id_"+area).addEventListener("keypress",(e=>{"Enter"===e.key&&(addStoredTag(prefix,area),showTags(prefix+area))}))},addStoredTag=(prefix,tagarea)=>{let tag=document.getElementById("id_"+tagarea).value;tag=tag.replace(","," ").trim();const tags=document.querySelector('[name="'+prefix+tagarea+'"]').value;document.getElementById("id_"+tagarea).value="",RegExp("\\b"+tag+"\\b").test(tags)||(document.querySelector('[name="'+prefix+tagarea+'"]').value=""===tags?tag:tags+","+tag)},addRemoveTagListener=tagarea=>{document.getElementById("local_oer_"+tagarea+"_tagarea").addEventListener("click",(e=>{if(e.target.dataset.name===tagarea)if("storedperson"===tagarea)removePerson(e.target.dataset);else{let name=e.target.dataset.value,tags=document.querySelector('[name="'+tagarea+'"]').value.split(","),result=[];tags.forEach((tag=>{""!==tag&&tag!==name&&result.push(tag)})),document.querySelector('[name="'+tagarea+'"]').value=result.join(","),showTags(tagarea)}}))},showTags=async tagarea=>{let entries=document.querySelector('[name="'+tagarea+'"]').value,tags={tags:[]};entries.length>0&&(entries=entries.split(","),entries.forEach((entry=>{tags.tags.push({tagarea:tagarea,tagvalue:entry,tag:entry})})));const{html:html,js:js}=await Templates.renderForPromise("local_oer/tags",tags);Templates.replaceNodeContents("#local_oer_"+tagarea+"_tagarea",html,js)},initSetPreferenceListener=modal=>{const button=document.getElementById("local_oer_preferenceResetButton");null!==button&&button.addEventListener("click",(action=>{action.preventDefault();let options={identifier:button.dataset.identifier,preference:button.dataset.preference},element=document.getElementById("local_oer_files_main_area");saveForm(modal,element,options,"FileinfoForm","FileinfoForm")}))},initPersonButtonListener=()=>{const button=document.getElementById("local_oer_addPersonButton");null!==button&&(showPersons(),button.addEventListener("click",(action=>{action.preventDefault(),showPersonForm()})))},showPersonForm=setInvalid=>{void 0===setInvalid&&(setInvalid=!1);const creator=document.querySelector('[name="creator"]').value,context=document.getElementById("local_oer_files_main_area").dataset.context,form=Fragment.loadFragment("local_oer","personform",context,{creator:creator});form.then((async()=>{const title=await Str.get_string("addpersonbtn","local_oer"),modal=await ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:title,body:form});if(await modal.setSaveButtonText(title),modal.getRoot().on(ModalEvents.hidden,(()=>{modal.destroy()})),modal.getRoot().on(ModalEvents.save,(()=>{const fields=modal.getRoot().find("form").serialize().split("&");let role="",firstname="",lastname="";fields.forEach((field=>{let pair=field.split("="),key=pair[0],value=pair[1];switch(key){case"role":role=value;break;case"firstname":firstname=value;break;case"lastname":lastname=value}}));addPerson({role:role,firstname:firstname,lastname:lastname})})),modal.show(),setInvalid){let element=document.getElementById("id_firstname");element.classList.add("is-invalid"),element=document.getElementById("id_lastname"),element.classList.add("is-invalid")}})).catch(_log.default.error)},addPerson=person=>{let names=document.querySelector('[name="storedperson"]').value;if(""!==names){names=JSON.parse(names);let found=!1,update=!1;if(names.persons.forEach(((storedname,key)=>{person.role===storedname.role&&person.firstname===storedname.firstname&&person.lastname===storedname.lastname&&(found=!0),person.role===storedname.role&&person.firstname+" "+person.lastname===storedname.fullname&&(found=!0,update=!0,names.persons[key].firstname=person.firstname,names.persons[key].lastname=person.lastname)})),""===person.firstname||""===person.lastname)return void showPersonForm(!0);found?update&&(document.querySelector('[name="storedperson"]').value=JSON.stringify(names)):(names.persons.push(person),document.querySelector('[name="storedperson"]').value=JSON.stringify(names))}else document.querySelector('[name="storedperson"]').value=JSON.stringify({persons:[person]});showPersons()},removePerson=person=>{let entries=document.querySelector('[name="storedperson"]').value;if(""===entries)return;entries=JSON.parse(entries);const persons={persons:[]};entries.persons.forEach((storedperson=>{person.role===storedperson.role&&(person.firstname===storedperson.firstname&&person.lastname===storedperson.lastname||person.fullname===storedperson.fullname)||persons.persons.push(storedperson)})),document.querySelector('[name="storedperson"]').value=JSON.stringify(persons),showPersons()},showPersons=async()=>{let entries=document.querySelector('[name="storedperson"]').value;if(""===entries)return;const roles=JSON.parse(document.querySelector('[name="personroletypes"]').value);let strings=[];roles.forEach((role=>{strings.push({key:role[1],component:role[2]})}));const results=await Str.get_strings(strings);entries=JSON.parse(entries);let persons={persons:[]};entries.persons.forEach((person=>{let localizedrole=results[0];roles.forEach(((role,index)=>{role[0]===person.role&&(localizedrole=results[index])})),persons.persons.push({role:person.role,firstname:person.firstname,lastname:person.lastname,fullname:person.fullname,name:decodeURI(localizedrole+": "+(void 0===person.fullname?person.firstname+" "+person.lastname:person.fullname))})})),renderPersonsTemplate(persons)},renderPersonsTemplate=async persons=>{const{html:html,js:js}=await Templates.renderForPromise("local_oer/persons",persons);Templates.replaceNodeContents("#local_oer_storedperson_tagarea",html,js)},showPagination=async()=>{const courseid=document.getElementById("local_oer_files_main_area").dataset.courseid;let filecount=parseInt(localStorage.getItem("local-oer-pagination-filecount-"+courseid),10);const filelist=document.getElementById("local-oer-overview-filelist").innerHTML,filemax=JSON.parse(filelist).files.length;let selected=localStorage.getItem("local-oer-pagination-selected-"+courseid),page=parseInt(localStorage.getItem("local-oer-pagination-current-"+courseid),10),pages=1;if(isNaN(filecount)&&(filecount=filemax),"all"!==selected){null===selected&&(selected="8");const amount=parseInt(selected,10);pages=Math.ceil(filecount/amount)}const result=[];if(isNaN(page)&&(page=1),page>pages&&(localStorage.setItem("local-oer-pagination-current-"+courseid,"1"),page=1),pages<=10)for(let i=1;i<=pages;i++)result.push({page:i,active:i===page,disabled:!1});else page<3||page>pages-2?(result.push({page:1,active:1===page,disabled:!1}),result.push({page:2,active:2===page,disabled:!1}),result.push({page:3,active:3===page,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:pages-2,active:page===pages-2,disabled:!1}),result.push({page:pages-1,active:page===pages-1,disabled:!1}),result.push({page:pages,active:page===pages,disabled:!1})):3===page?(result.push({page:1,active:!1,disabled:!1}),result.push({page:2,active:!1,disabled:!1}),result.push({page:3,active:!0,disabled:!1}),result.push({page:4,active:!1,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:pages-1,active:page===pages-1,disabled:!1}),result.push({page:pages,active:page===pages,disabled:!1})):page===pages-2?(result.push({page:1,active:!1,disabled:!1}),result.push({page:2,active:!1,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:pages-3,active:!1,disabled:!1}),result.push({page:pages-2,active:!0,disabled:!1}),result.push({page:pages-1,active:!1,disabled:!1}),result.push({page:pages,active:page===pages,disabled:!1})):(result.push({page:1,active:!1,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:page-1,active:!1,disabled:!1}),result.push({page:page,active:!0,disabled:!1}),result.push({page:page+1,active:!1,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:pages,active:!1,disabled:!1}));const data={selectoptions:paginationSelectOptions(selected),control:1!==pages,previous:page>1,next:page<pages,pages:1!==pages&&result,filecount:filecount,filemax:filemax},{html:html,js:js}=await Templates.renderForPromise("local_oer/pagination",data);Templates.replaceNodeContents("#local-oer-pagination",html,js),addPaginationListeners(pages)},paginationSelectOptions=selected=>[{value:"4",selected:"4"===selected},{value:"8",selected:"8"===selected},{value:"12",selected:"12"===selected},{value:"16",selected:"16"===selected},{value:"32",selected:"32"===selected},{value:"64",selected:"64"===selected},{value:"all",selected:"all"===selected}],addPaginationListeners=pages=>{let courseid=document.getElementById("local_oer_files_main_area").dataset.courseid,selected=localStorage.getItem("local-oer-pagination-selected-"+courseid),page=localStorage.getItem("local-oer-pagination-current-"+courseid);null!==page&&"undefined"!==page||localStorage.setItem("local-oer-pagination-current-"+courseid,"1"),null!==selected&&"undefined"!==selected||localStorage.setItem("local-oer-pagination-selected-"+courseid,"8");let selectlistener=document.getElementById("local-oer-pagination-select"),pagelistener=document.getElementById("local-oer-pagination-pages");selectlistener.addEventListener("change",(action=>{action.preventDefault();let value=action.target.value;localStorage.setItem("local-oer-pagination-selected-"+courseid,value),localStorage.setItem("local-oer-pagination-current-"+courseid,"1"),showFiles(!1,!1)})),pagelistener.addEventListener("click",(action=>{action.preventDefault();let value=action.target.dataset.page;if(void 0===value||".."===value)return;let page=parseInt(localStorage.getItem("local-oer-pagination-current-"+courseid));switch(value){case"previous":value=page>1?page-1:1;break;case"next":value=page<pages?page+1:pages}localStorage.setItem("local-oer-pagination-current-"+courseid,value),showFiles(!1,!1)}))}}));

//# sourceMappingURL=output-lazy.min.js.map